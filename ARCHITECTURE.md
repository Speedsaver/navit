# Theory of operation #

Speedsaver Navit is based on an extremely stripped down version of the popular
[Navit](https://github.com/navit-gps/navit) software.

While upstream Navit handles all the features you'd expect of GPS-based
navigation software, this software only handles the following:

- Generating binary maps from OpenStreetMap XML files
- Tracking a vehicle by GPS
- Looking up the current street from a binary map
- Displaying the current and maximum speeds over an I2C display

## Attributes ##

The core data structure in Navit's architecture is the attribute.

Attributes are data structures containing two members:

1. A number indicating the attribute's purpose. Numbers are grouped by data type.
2. The actual data, such as a string, number, coordinate or map item

An example attribute would have the following members:

1. The 'maxspeed' attribute number, grouped in the 'int' type
2. The integer 60

In the case of maxspeed it is attached to a map item and represents the
maximum speed a vehicle is allowed to drive on a street.

Another example attribute would have the following members:

1. The 'position_coord_geo' attribute number, grouped in the 'coord' type
2. A 2D coordinate

In this case position_coord_geo describes a position on Earth.
In the stripped down codebase it represents the vehicle's GPS location.

Attributes can be created from byte streams or formatted as byte streams.

While attributes for the most part map cleanly to tags used in map files,
attributes are used throughout the codebase for identifying and representing
almost every piece of non-trivial data.

Most of the time attributes are not dealt with directly but through a list.
Attribute lists let you add, remove, query and update select pieces of data
usually attached to some other data structure. Keep this in mind for later.

## Map items ##

OpenStreetMap divides map elements in to three different categories:

- Nodes
- Ways
- Relations

Each of these has one or more coordinates and properties.

Navit simplifies this by defining a map item to be the following:

- A list of attributes
- A list of coordinates

Broadly speaking a map is a collection of these items and a mapset is a
collection of maps. Any data needed from a map is found by traversing these
data structures, often with a GPS vehicle as reference.

For example, here's how finding the max speed from GPS coordinates work:

- The GPS vehicle is queried for its coordinate attribute
- A rectangle of a radius is drawn around this coordinate
- The map is queried for all items in this rectangle
- Each item is queried check if it is a street
- A linked list is made from each street item
- The closest item in the list is chosen as current street
- The street's maxspeed attribute is chosen for display

The actual map itself is stored as binfile zip generated by MapTool.

## Navit objects ##

Navit includes an object framework used for each of the modules in the program.
The purpose of this is to allow configuring a rich system of modules tailored
to the specific platform and hardware and use.

Objects contain the following data:

- A type
- A reference count for garbage collection
- A list of attributes
- Private data hidden by casting from another struct

This data may not be accessed directly but instead through predefined methods.
Each method may be overridden for more dynamic behaviour. For example this is
done in the GPS vehicle to return the current coordinates from fresh data
instead of storing it in an attribute list.

No new methods may be added. This means that any behaviour specific to the object
or implementation must be done through attributes. This is effectively using
attributes to implement message passing.

In some cases 'static' objects can be created and used by returning a dummy
object of sorts with custom methods and reference counting disabled.
An example of this is the 'debug' object which sets global variables on
'creation' and returns a static dummy object to the caller.

## XML configuration ##

For the most part objects are created during parsing of the XML configuration
file. The XML parser does the following:

- Steps through each XML element in the file
- Parses each XML attribute to a Navit attribute based on the attribute name
- Creates an object based on the XML element tag
- Passes the Navit attributes to the object
- Passes the object associated with the parent XML tag to the object

The mapping of all XML elements to Navit elements is defined in the XML parser.

## Callbacks ##

Navit supports function callbacks. These are attributes that contain:

- A function pointer
- The function parameter count
- A list of stored parameters
- An attribute type

Callbacks are called with additional parameters that are combined with the
stored parameters to create an C actual function call.

An example of a callback is:

- A pointer to 'set attr' on an object
- A stored parameter for the object address
- A stored parameter for the attribute type
- The value to set is passed when the callback is called

This is very similar to the creation and use of std::bind in C++.

Much like attributes, callbacks are generally dealt with as lists. This is used
to implement the observer pattern by triggering callbacks associated with a
specific attribute type.

By default Navit objects implement this observer pattern. This means:

- Object A and B can register callbacks on an object for attribute X
- Object C can register a callback on an object for attribute Y
- When attribute X is set on the object, objects A and B are called
- When attribute Y is set on the object, object C is called

## Event loop ##

While most control flow in Navit is managed using traditional function calls as
well as callbacks, there is an event loop that supports running callbacks when:

- A file descriptor is ready for reading or writing
- A timeout has been reached
- Nothing else is happening

Some examples of this:

- The GPS vehicle handles a file descriptor for the libgps socket
- The I2C display updates every 100 milliseconds
- Upstream Navit incrementally builds a navigation route when idle

## Plugins ##

Upstream Navit supports a modular plugin system that separates interfaces and
implementations for various subsystems. This would work by:

- Creating an interface for some subsystem, such as maps
- Loading a shared library and running initialization code
- Running the plugin's methods from the interface

The specific shared library would be chosen based on the XML configuration.

This version of Navit has removed almost all uses of the plugin system but the
core infrastructure still remains.

# File reference #

For the purposes of development the following is a list of all files in this Git
repository and what the files do.

## Documentation ##

- AUTHORS - Navit authors
- ChangeLog - Navit changelog
- COPYING - Navit copyright information
- COPYRIGHT - Navit copyright notice
- GPL-2 - GPLv2 license
- LGPL-2 - LGPLv2 license
- README.md - README file
- ARCHITECTURE.md - This file!

## Development ##

- meson.build - Meson build configuration
- .gitignore - List of files to ignore in Git
- navit/Doxyfile - Doxygen configuration

## Utility code ##

- navit/navit_nls.c - Stub code, formerly translated strings
- navit/endianess.h - Defines byteswapping macros
- navit/atom.c - Maps duplicate strings to a single string pointer
- navit/cache.c - Memory-based cache for arbitrary data
- navit/zipfile.h - ZIP file data structures
- navit/coord.c - Coordinate handling
- navit/transform.c - Coordinate transformation
- navit/projection.c - Coordinate projections
- navit/country.c - Country lookup utilities
- navit/point.h - 2D point definition
- navit/util.c - Timestamp parsing, process spawning, min/max, case changing
- navit/geom.c - Geometry utilities
- navit/file.c - Filesystem access
- navit/param.c - String-based parameter lists
- navit/debug.c - Debug logging
- navit/linguistics.c - Handles string operations on non-English characters

## Core code ##

- navit/attr_def.h - List of all attribute types and flags
- navit/attr.c - Attributes
- navit/callback.c - Callbacks
- navit/xmlconfig.c - Object configuration and creation
- navit/navit_shipped.xml - Navit XML configuration
- navit/event.c - Event loop interface
- navit/event_glib.c - Event loop Glib implementation
- navit/track.c - Vehicle tracking information
- navit/vehicle.c - Vehicles
- navit/item_def.h - List of all map item types and flags
- navit/item.c - Map items
- navit/map.c - Map file handling
- navit/maps.c - Configuration element to load maps using a wildcard filename
- navit/mapset.c - Sets of maps
- navit/plugin_def.h - All plugin categories and functions
- navit/plugin.h - Macros for using or defining plugins
- navit/plugin.c - Finds and loads plugins by category and name

## Application code ##

- navit/start_real.c - Application entry point
- navit/start.c - main stub, calls code in start_real
- navit/navit.service.in - systemd unit template
- navit/main.c - Sets up the NAVIT_* environment variables
- navit/config_.c - <config> object, sets up signals and LANG
- navit/graphics/ssd1306/graphics_ssd1306.cpp - SSD1306 GUI for Speedsaver
- navit/graphics/ssd1306/graphics_init_animation.cpp - Animations for SSD1306
- navit/graphics/ssd1306/tone7.wav - Tone that plays when over speed
- navit/map/binfile/binfile.c - Binfile map format
- navit/vehicle/gpsd/vehicle_gpsd.c - GPS vehicle
- navit/navit.c - Core object handling user commands and global state

## MapTool ##

- navit/maptool/maptool.c - Application entry and core logic
- navit/maptool/misc.c - Random utility functions
- navit/maptool/buffer.c - Saves and loads buffers from files
- navit/maptool/zip.c - ZIP file handling
- navit/maptool/tempfile.c - Creates and deletes temporary files
- navit/maptool/boundaries.c - Handles administrative boundaries
- navit/maptool/coastline.c - Handles coastline data
- navit/maptool/osm.c - OpenStreetMap to Navit attribute mapping
- navit/maptool/osm_xml.c - OpenStreetMap XML parser
- navit/maptool/osm_relations.c - Relations collections
- navit/maptool/tile.c - Tile management
- navit/maptool/itembin.c - Item handling, items are attributes and coords
- navit/maptool/itembin_buffer.c - Buffer for temporary items
- navit/maptool/sourcesink.c - Reads and writes groups of items to files
